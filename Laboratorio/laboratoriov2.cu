#include <stdio.h>
#include <stdlib.h>
#include "cuda.h"

#define MATRIX_COLUMNS 5000
#define MATRIX_ROWS 4000

#define TILE_A_ROWS 4
#define TILE_A_COLS 5
#define TILE_B_ROWS 5
#define TILE_B_COLS 5

#define VALUE_TYPE float

__device__ __constant__ int hA_mas[76][6]=
{{11,	-1,	-1,	-1,	-1,	-1},
{6,	9,	-1,	-1,	-1,	-1},
{16,	-1,	-1,	-1,	-1,	-1},
{1,	3,	13,	-1,	-1,	-1},
{4,	6,	9,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{15,	-1,	-1,	-1,	-1,	-1},
{11,	-1,	-1,	-1,	-1,	-1},
{18,	-1,	-1,	-1,	-1,	-1},
{6,	9,	-1,	-1,	-1,	-1},
{16,	-1,	-1,	-1,	-1,	-1},
{15,	-1,	-1,	-1,	-1,	-1},
{1,	3,	8,	-1,	-1,	-1},
{2,	12,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{12,	-1,	-1,	-1,	-1,	-1},
{1,	3,	6,	8,	12,	16},
{5,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{5,	7,	-1,	-1,	-1,	-1},
{5,	7,	-1,	-1,	-1,	-1},
{2,	-1,	-1,	-1,	-1,	-1},
{2,	-1,	-1,	-1,	-1,	-1},
{4,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{3,	4,	-1,	-1,	-1,	-1},
{2,	12,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{10,	-1,	-1,	-1,	-1,	-1},
{10,	13,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{5,	15,	18,	-1,	-1,	-1},
{17,	-1,	-1,	-1,	-1,	-1},
{18,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{7,	-1,	-1,	-1,	-1,	-1},
{19,	-1,	-1,	-1,	-1,	-1},
{12,	-1,	-1,	-1,	-1,	-1},
{19,	-1,	-1,	-1,	-1,	-1},
{3,	4,	-1,	-1,	-1,	-1},
{15,	-1,	-1,	-1,	-1,	-1},
{9,	-1,	-1,	-1,	-1,	-1},
{8,	-1,	-1,	-1,	-1,	-1},
{7,	11,	-1,	-1,	-1,	-1},
{13,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{5,	14,	-1,	-1,	-1,	-1},
{12,	-1,	-1,	-1,	-1,	-1},
{3,	4,	8,	9,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{6,	-1,	-1,	-1,	-1,	-1},
{16,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{1,	3,	12,	17,	-1,	-1},
{3,	-1,	-1,	-1,	-1,	-1},
{0,	19,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{13,	18,	-1,	-1,	-1,	-1},
{9,	19,	-1,	-1,	-1,	-1},
{3,	13,	-1,	-1,	-1,	-1},
{5,	15,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{0,	10,	-1,	-1,	-1,	-1},
{15,	-1,	-1,	-1,	-1,	-1},
{0,	2,	12,	16,	-1,	-1},
{9,	-1,	-1,	-1,	-1,	-1},
{0,	2,	18,	19,	-1,	-1},
{3,	8,	-1,	-1,	-1,	-1},
{7,	17,	-1,	-1,	-1,	-1},
{12,	14,	17,	19,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{2,	7,	-1,	-1,	-1,	-1},
{5,	8,	12,	-1,	-1,	-1},
{6,	9,	10,	15,	-1, -1},
{2,	12,	-1,	-1,	-1,	-1}};

__device__ __constant__ int hA_menos[76][6] =
{{-1,	-1,	-1,	-1,	-1,	-1},
{14,	-1,	-1,	-1,	-1,	-1},
{10,	15,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{6,	9,	19,	-1,	-1,	-1},
{0,	16,	-1,	-1,	-1,	-1},
{12,	17,	-1,	-1,	-1,	-1},
{1,	3,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{5,	15,	-1,	-1,	-1,	-1},
{16,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{11,	-1,	-1,	-1,	-1,	-1},
{1,	3,	-1,	-1,	-1,	-1},
{11,	-1,	-1,	-1,	-1,	-1},
{5,	7,	11,	15,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{7,	-1,	-1,	-1,	-1,	-1},
{4,	9,	-1,	-1,	-1,	-1},
{9,	-1,	-1,	-1,	-1,	-1},
{3,	8,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{0,	-1,	-1,	-1,	-1,	-1},
{2,	-1,	-1,	-1,	-1,	-1},
{10,	-1,	-1,	-1,	-1,	-1},
{13,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{12,	-1,	-1,	-1,	-1,	-1},
{3,	4,	13,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{19,	-1,	-1,	-1,	-1,	-1},
{9,	19,	-1,	-1,	-1,	-1},
{15,	18,	-1,	-1,	-1,	-1},
{7,	10,	13,	-1,	-1,	-1},
{10,	15,	18,	-1,	-1,	-1},
{2,	18,	-1,	-1,	-1,	-1},
{0,	19,	-1,	-1,	-1,	-1},
{5,	14,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{12,	-1,	-1,	-1,	-1,	-1},
{12,	17,	-1,	-1,	-1,	-1},
{14,	-1,	-1,	-1,	-1,	-1},
{9,	10,	-1,	-1,	-1,	-1},
{7,	-1,	-1,	-1,	-1,	-1},
{0,	2,	5,	7,	-1,	-1},
{3,	8,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{1,	-1,	-1,	-1,	-1,	-1},
{6,	9,	11,	16,	18,	19},
{18,	-1,	-1,	-1,	-1,	-1},
{4,	15,	-1,	-1,	-1,	-1},
{10,	15,	-1,	-1,	-1,	-1},
{3,	4,	13,	14,	-1,	-1},
{12,	17,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{12,	17,	-1,	-1,	-1,	-1},
{2,	3,	12,	13,	-1,	-1},
{0,	-1,	-1,	-1,	-1,	-1},
{1,	4,	6,	9,	11,	15},
{14,	-1,	-1,	-1,	-1,	-1},
{3,	4,	15,	17,	-1,	-1},
{2,	7,	-1,	-1,	-1,	-1},
{9,	19,	-1,	-1,	-1,	-1},
{10,	13,	15,	18,	-1,	-1},
{5,	8,	15,	18,	-1,	-1},
{3,	4,	8,	9,	-1,	-1},
{7,	10,	13,	-1,	-1,	-1},
{1,	3,	11,	13,	14,	16},
{-1,	-1,	-1,	-1,	-1,	-1}};

__device__ __constant__ int hB_mas[76][7]=
{{-1,	-1,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1,	-1},
{9,	-1,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1,	-1},
{20,	-1,	-1,	-1,	-1,	-1,	-1},
{7,	20,	-1,	-1,	-1,	-1,	-1},
{0,	8,	-1,	-1,	-1,	-1,	-1},
{10,	-1,	-1,	-1,	-1,	-1,	-1},
{7,	15,	-1,	-1,	-1,	-1,	-1},
{20,	-1,	-1,	-1,	-1,	-1,	-1},
{6,	-1,	-1,	-1,	-1,	-1,	-1},
{0,	-1,	-1,	-1,	-1,	-1,	-1},
{6,	15,	-1,	-1,	-1,	-1,	-1},
{8,	10,	-1,	-1,	-1,	-1,	-1},
{15,	-1,	-1,	-1,	-1,	-1,	-1},
{10,	-1,	-1,	-1,	-1,	-1,	-1},
{6,	-1,	-1,	-1,	-1,	-1,	-1},
{0,	1,	21,	-1,	-1,	-1,	-1},
{10,	11,	21,	-1,	-1,	-1,	-1},
{3,	-1,	-1,	-1,	-1,	-1,	-1},
{21,	-1,	-1,	-1,	-1,	-1,	-1},
{0,	1,	13,	18,	-1,	-1,	-1},
{13,	18,	-1,	-1,	-1,	-1,	-1},
{23,	-1,	-1,	-1,	-1,	-1,	-1},
{0,	-1,	-1,	-1,	-1,	-1,	-1},
{18,	-1,	-1,	-1,	-1,	-1,	-1},
{0,	4,	14,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1,	-1},
{0,	4,	14,	-1,	-1,	-1,	-1},
{14,	-1,	-1,	-1,	-1,	-1,	-1},
{23,	-1,	-1,	-1,	-1,	-1,	-1},
{2,	-1,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1,	-1},
{15,	17,	-1,	-1,	-1,	-1,	-1},
{2,	20,	22,	-1,	-1,	-1,	-1},
{10,	11,	12,	21,	-1,	-1,	-1},
{2,	-1,	-1,	-1,	-1,	-1,	-1},
{14,	15,	16,	19,	-1,	-1,	-1},
{2,	20,	22,	24,	-1,	-1,	-1},
{13,	18,	-1,	-1,	-1,	-1,	-1},
{2,	10,	12,	20,	22,	-1,	-1},
{15,	16,	19,	-1,	-1,	-1,	-1},
{15,	16,	-1,	-1,	-1,	-1,	-1},
{6,	-1,	-1,	-1,	-1,	-1,	-1},
{14,	15,	17,	19,	20,	22,	24},
{-1,	-1,	-1,	-1,	-1,	-1,	-1},
{0,	1,	4,	-1,	-1,	-1,	-1},
{6,	11,	14,	15,	16,	19,	-1},
{3,	-1,	-1,	-1,	-1,	-1,	-1},
{6,	13,	18,	-1,	-1,	-1,	-1},
{5,	6,	-1,	-1,	-1,	-1,	-1},
{0,	5,	7,	-1,	-1,	-1,	-1},
{8,	15,	-1,	-1,	-1,	-1,	-1},
{7,	-1,	-1,	-1,	-1,	-1,	-1},
{10,	12,	17,	-1,	-1,	-1,	-1},
{10,	12,	20,	22,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1,	-1},
{23,	-1,	-1,	-1,	-1,	-1,	-1},
{15,	17,	19,	20,	22,	24,	-1},
{7,	-1,	-1,	-1,	-1,	-1,	-1},
{0,	4,	19,	23,	-1,	-1,	-1},
{1,	2,	6,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1,	-1},
{0,	4,	-1,	-1,	-1,	-1,	-1},
{3,	8,	23,	-1,	-1,	-1,	-1},
{8,	-1,	-1,	-1,	-1,	-1,	-1},
{0,	1,	4,	21,	24,	-1,	-1},
{13,	-1,	-1,	-1,	-1,	-1,	-1},
{13,	23,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1,	-1},
{15,	16,	17,	-1,	-1,	-1,	-1},
{0,	1,	8,	21,	-1,	-1,	-1},
{15,	16,	19,	-1,	-1,	-1,	-1},
{9,	-1,	-1,	-1,	-1,	-1,	-1},
{3,	8,	13,	-1,	-1,	-1,	-1}};

__device__ __constant__ int hB_menos[76][6]=
{{5,	9,	10,	-1,	-1,	-1},
{9,	20,	-1,	-1,	-1,	-1},
{0,	-1,	-1,	-1,	-1,	-1},
{9,	15,	-1,	-1,	-1,	-1},
{8,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{7,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{0,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{0,	1,	21,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{3,	10,	11,	-1,	-1,	-1},
{10,	-1,	-1,	-1,	-1,	-1},
{18,	20,	-1,	-1,	-1,	-1},
{3,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{3,	-1,	-1,	-1,	-1,	-1},
{14,	15,	19,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{18,	20,	24,	-1,	-1,	-1},
{15,	16,	17,	-1,	-1,	-1},
{10,	12,	-1,	-1,	-1,	-1},
{2,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{10,	12,	-1,	-1,	-1,	-1},
{13,	23,	-1,	-1,	-1,	-1},
{0,	1,	4,	21,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{10,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{20,	24,	-1,	-1,	-1,	-1},
{15,	16,	19,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{0,	1,	-1,	-1,	-1,	-1},
{10,	11,	16,	-1,	-1,	-1},
{20,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{5,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{7,	13,	18,	-1,	-1,	-1},
{13,	23,	-1,	-1,	-1,	-1},
{2,	4,	9,	20,	22,	24},
{20,	24,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{10,	11,	12,	21,	22,	-1},
{3,	9,	18,	20,	24,	-1},
{15,	16,	17,	-1,	-1,	-1},
{7,	12,	14,	15,	17,	19},
{3,	-1,	-1,	-1,	-1,	-1},
{2,	20,	22,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{9,	15,	16,	19,	-1,	-1},
{10,	12,	-1,	-1,	-1,	-1},
{8,	10,	11,	21,	-1,	-1},
{10,	11,	12,	-1,	-1,	-1},
{20,	22,	24,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{3,	23,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{-1,	-1,	-1,	-1,	-1,	-1},
{0,	4,	14,	-1,	-1,	-1}};



__device__ __constant__ int hC_mas[20][8] =
{{11,13,52,4 ,-1,-1,-1,-1},
 {12,14,19,20,22,24,48,49},
 {14,22,23,33,39,54,-1,-1},
 {11,13,22,23,24,25,4 ,-1},
 {14,23,24,26,29,30,60,63},
 {9 ,10,12,14,15,50,-1,-1},
 {11,16,17,42,43,-1,-1,-1},
 {18,31,34,35,36,-1,-1,-1},
 {9 ,17,19,72,-1,-1,-1,-1},
 {41,45,66,73,-1,-1,-1,-1},
 {9 ,14,15,1 ,2 ,74,-1,-1},
 {41,43,47,-1,-1,-1,-1,-1},
 {32,36,44,62,-1,-1,-1,-1},
 {15,26,28,30,45,75,-1,-1},
 {11,27,28,45,3 ,-1,-1,-1},
 {11,51,53,8 ,-1,-1,-1,-1},
 {10,20,32,61,-1,-1,-1,-1},
 {9 ,14,15,33,5 ,7 ,-1,-1},
 {11,24,25,40,64,-1,-1,-1},
 {29,34,38,2 ,56,58,-1,-1}};

__device__ __constant__ int hC_menos[20][8] =
{{9 ,14,15,65,6 ,-1,-1,-1},
 {21,42,-1,-1,-1,-1,-1,-1},
 {36,40,55,8 ,-1,-1,-1,-1},
 {9 ,15,65,6 ,-1,-1,-1,-1},
 {27,3 ,-1,-1,-1,-1,-1,-1},
 {11,16,43,-1,-1,-1,-1,-1},
 {10,12,14,15,18,20,-1,-1},
 {9 ,42,59,5 ,71,-1,-1,-1},
 {18,21,23,25,4 ,68,-1,-1},
 {9 ,17,1 ,29,37,42,-1,-1},
 {11,0 ,3 ,-1,-1,-1,-1,-1},
 {15,18,20,27,28,37,46,-1},
 {15,27,38,45,70,7 ,-1,-1},
 {13,22,25,57,-1,-1,-1,-1},
 {9 ,14,1 ,29,2 ,74,-1,-1},
 {9 ,14,15,5 ,7 ,-1,-1,-1},
 {11,17,31,33,35,69,-1,-1},
 {32,34,36,53,8 ,-1,-1,-1},
 {32,34,39,67,6 ,-1,-1,-1},
 {11,28,33,44,-1,-1,-1,-1}};




#define CUDA_CHK(ans)                         \
    {                                         \
        gpuAssert((ans), __FILE__, __LINE__); \
    }

inline void gpuAssert(cudaError_t code, const char *file, int line, bool abort = true)
{
    if (code != cudaSuccess)
    {
        fprintf(stderr, "GPUassert: %s %s %d\n", cudaGetErrorString(code), file, line);
        if (abort)
            exit(code);
    }
}

__device__ void producto_sub_bloque_device(const VALUE_TYPE *a_sub, const VALUE_TYPE *b_sub, VALUE_TYPE *c_sub_result, VALUE_TYPE *h_results)
{
    int id = threadIdx.x;

    if (id < 76)
    {
        VALUE_TYPE parc_a = 0;
        VALUE_TYPE parc_b = 0;

        for (int i = 0; i < 6; i++) {
            int idx = hA_mas[id][i];
            if (idx == -1) break;
            parc_a += a_sub[idx];
        }
        for (int i = 0; i < 6; i++) {
            int idx = hA_menos[id][i];
            if (idx == -1) break;
            parc_a -= a_sub[idx];
        }

        for (int i = 0; i < 7; i++) {
            int idx = hB_mas[id][i];
            if (idx == -1) break;
            parc_b += b_sub[idx];
        }
        for (int i = 0; i < 6; i++) {
            int idx = hB_menos[id][i];
            if (idx == -1) break;
            parc_b -= b_sub[idx];
        }

        h_results[id] = parc_a * parc_b;
    }

    __syncthreads();

    if (id < (TILE_A_ROWS * TILE_B_COLS))
    {
        VALUE_TYPE parc_c = 0;
        
        for (int i = 0; i < 8; i++) {
            int idx = hC_mas[id][i];
            if (idx == -1) break;
            parc_c += h_results[idx];
        }
        for (int i = 0; i < 8; i++) {
            int idx = hC_menos[id][i];
            if (idx == -1) break;
            parc_c -= h_results[idx];
        }
        c_sub_result[id] = parc_c;
    }
}


__global__ void calculo_matriz(const VALUE_TYPE *a_global, const VALUE_TYPE *b_global, VALUE_TYPE *c_global)
{
    int tile_row = blockIdx.y;
    int tile_col = blockIdx.x;

    __shared__ VALUE_TYPE a_sub[TILE_A_ROWS * TILE_A_COLS];
    __shared__ VALUE_TYPE b_sub[TILE_B_ROWS * TILE_B_COLS];
    
    __shared__ VALUE_TYPE c_sub[TILE_A_ROWS * TILE_A_COLS];
    
    __shared__ VALUE_TYPE h_results[76];
    __shared__ VALUE_TYPE c_temp_sub[TILE_A_ROWS * TILE_A_COLS];

    int tid = threadIdx.x;

    if (tid < (TILE_A_ROWS * TILE_A_COLS)) {
        c_sub[tid] = 0.0f;
    }
    
    int num_tiles_k = MATRIX_COLUMNS / TILE_A_COLS;

    for (int k_tile = 0; k_tile < num_tiles_k; ++k_tile) {
        if (tid < (TILE_A_ROWS * TILE_A_COLS)) {
            int row_a = tile_row * TILE_A_ROWS + tid / TILE_A_COLS;
            int col_a = k_tile * TILE_A_COLS + tid % TILE_A_COLS;
            a_sub[tid] = a_global[row_a * MATRIX_COLUMNS + col_a];
        }

        if (tid < (TILE_B_ROWS * TILE_B_COLS)) {
             int row_b = k_tile * TILE_B_ROWS + tid / TILE_B_COLS;
             int col_b = tile_col * TILE_B_COLS + tid % TILE_B_COLS;
             b_sub[tid] = b_global[row_b * MATRIX_COLUMNS + col_b];
        }

        __syncthreads();

        producto_sub_bloque_device(a_sub, b_sub, c_temp_sub, h_results);
        
        __syncthreads();
        
        if (tid < (TILE_A_ROWS * TILE_A_COLS)) {
            c_sub[tid] += c_temp_sub[tid];
        }

        __syncthreads();
    }

    if (tid < (TILE_A_ROWS * TILE_A_COLS)) {
        int row_c = tile_row * TILE_A_ROWS + tid / TILE_A_COLS;
        int col_c = tile_col * TILE_B_COLS + tid % TILE_A_COLS;
        c_global[row_c * MATRIX_COLUMNS + col_c] = c_sub[tid];
    }
}

int main(int argc, char *argv[])
{
    VALUE_TYPE *h_A, *h_B, *h_C, *d_A, *d_B, *d_C;

    int size_A = sizeof(VALUE_TYPE) * MATRIX_ROWS * MATRIX_COLUMNS;
    int size_B = sizeof(VALUE_TYPE) * MATRIX_COLUMNS * MATRIX_COLUMNS;
    int size_C = sizeof(VALUE_TYPE) * MATRIX_ROWS * MATRIX_COLUMNS;

    h_A = (VALUE_TYPE *)malloc(size_A);
    h_B = (VALUE_TYPE *)malloc(size_B);
    h_C = (VALUE_TYPE *)malloc(size_C);

    for (int i = 0; i < MATRIX_ROWS * MATRIX_COLUMNS; i++) h_A[i] = 1.0f;
    for (int i = 0; i < MATRIX_COLUMNS * MATRIX_COLUMNS; i++) h_B[i] = 1.0f;

    CUDA_CHK(cudaMalloc((void **)&d_A, size_A));
    CUDA_CHK(cudaMalloc((void **)&d_B, size_B));
    CUDA_CHK(cudaMalloc((void **)&d_C, size_C));

    CUDA_CHK(cudaMemcpy(d_A, h_A, size_A, cudaMemcpyHostToDevice));
    CUDA_CHK(cudaMemcpy(d_B, h_B, size_B, cudaMemcpyHostToDevice));

    dim3 threadsPerBlock(96);
    dim3 numBlocks(MATRIX_COLUMNS / TILE_B_COLS, MATRIX_ROWS / TILE_A_ROWS);

    calculo_matriz<<<numBlocks, threadsPerBlock>>>(d_A, d_B, d_C);
    
    CUDA_CHK(cudaGetLastError());
    CUDA_CHK(cudaDeviceSynchronize());

    CUDA_CHK(cudaMemcpy(h_C, d_C, size_C, cudaMemcpyDeviceToHost));

    printf("Result matrix C (top-left 4x5 tile):\n");
    for (int i = 0; i < 4; i++) {
        for (int j = 0; j < 5; j++) {
            printf("%f ", h_C[i * MATRIX_COLUMNS + j]);
        }
        printf("\n");
    }

    free(h_A);
    free(h_B);
    free(h_C);
    CUDA_CHK(cudaFree(d_A));
    CUDA_CHK(cudaFree(d_B));
    CUDA_CHK(cudaFree(d_C));

    return 0;
}